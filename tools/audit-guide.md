# OpenTDF Audit Logging and Compliance Reporting Guide

This guide explains how to use and interpret the audit logs and compliance reports generated by the OpenTDF ABAC implementation.

## Overview

The OpenTDF attribute-based access control (ABAC) system includes comprehensive audit logging for all access attempts, attribute verifications, policy evaluations, and compliance reporting. This provides:

- Complete visibility into who accessed protected information
- Evidence of policy enforcement for compliance requirements
- Detailed information on attribute evaluation for each policy condition
- Support for forensic analysis of access patterns and security events

## Running the Audit Logging Test

The `audit-logging-test.js` script provides a comprehensive demonstration of the audit logging capabilities:

```bash
# Run the audit logging test
node tools/audit-logging-test.js

# This will:
# 1. Create test users with different attributes
# 2. Define policies with various attribute conditions
# 3. Create protected TDF documents
# 4. Test multiple access scenarios (both success and failure cases)
# 5. Generate audit logs for all operations
# 6. Create compliance reports in the reports/ directory
```

## Understanding Audit Log Records

Each audit log entry contains the following information:

### 1. Access Attempt Records

```json
{
  "timestamp": "2023-04-01T12:34:56.789Z",
  "eventType": "accessAttempt",
  "userId": "alice@example.com",
  "documentId": "doc-uuid-123",
  "policyId": "policy-uuid-456",
  "accessGranted": true,
  "evaluationResults": [
    {
      "attribute": "gov.example:clearance",
      "required": "confidential",
      "provided": "top-secret",
      "operator": "MinimumOf",
      "satisfied": true,
      "reason": "Hierarchical attribute satisfied via inheritance"
    },
    // Additional attribute evaluations...
  ],
  "environmentContext": {
    "ipAddress": "10.0.0.1",
    "userAgent": "Browser/App Information",
    "timestamp": "2023-04-01T12:34:56.789Z",
    "securityContext": "Session information"
  }
}
```

### 2. Attribute Verification Records

```json
{
  "timestamp": "2023-04-01T12:30:00.000Z",
  "eventType": "attributeVerification",
  "userId": "alice@example.com",
  "attributes": [
    {
      "name": "gov.example:clearance",
      "value": "top-secret",
      "source": "identity-provider",
      "verified": true
    },
    // Additional attributes...
  ]
}
```

### 3. Policy Binding Verification

```json
{
  "timestamp": "2023-04-01T12:45:00.000Z",
  "eventType": "policyBindingVerification",
  "documentId": "doc-uuid-123",
  "policyId": "policy-uuid-456",
  "bindingValid": true,
  "bindingAlgorithm": "HS256",
  "verificationTimestamp": "2023-04-01T12:45:00.000Z",
  "verifier": "compliance-system"
}
```

## Compliance Reports

The system generates several types of compliance reports:

1. **Access Attempts Report** - Lists all access attempts with details on user, time, and success/failure
2. **Attribute Verification Report** - Shows all attribute verifications with sources and validation status
3. **Policy Evaluation Report** - Provides detailed evaluation results for specific documents
4. **Comprehensive Report** - Includes all audit records with full details

### Example Report Structure

```json
{
  "generatedAt": "2023-04-01T13:00:00.000Z",
  "reportType": "accessAttempts",
  "parameters": {
    "timeRange": "24h",
    "includeSuccessful": true,
    "includeDenied": true
  },
  "data": [
    // Array of relevant audit records
  ]
}
```

## Using Audit Logs for Compliance

Common compliance scenarios supported by the audit logs:

1. **Access Reporting**: Generate reports of who accessed specific documents over a time period
2. **Policy Enforcement Validation**: Verify that access controls were properly enforced
3. **Attribute Usage Analysis**: Track which attributes are most commonly used in access decisions
4. **Security Investigation**: Review failed access attempts for potential security incidents
5. **Regulatory Compliance**: Provide evidence of proper controls for regulations like GDPR, HIPAA, etc.

## Best Practices

1. **Retention Period**: Keep audit logs for the period required by relevant regulations
2. **Periodic Review**: Regularly review access patterns for anomalies
3. **Secure Storage**: Store audit logs in a secure, tamper-evident system
4. **Automated Alerting**: Create alerts for unusual access patterns or multiple failures
5. **Regular Reporting**: Generate compliance reports on a scheduled basis

## Extending the Audit System

The audit logging system can be extended in the following ways:

1. Add additional attributes to capture in access logs
2. Implement real-time streaming of audit events to SIEM systems
3. Create custom report formats for specific compliance requirements
4. Add automated analysis to detect potential issues
5. Integrate with existing organizational logging infrastructure

## Troubleshooting

If audit logs or reports appear incomplete:

1. Verify that the MCP server is running with appropriate permissions
2. Check that audit logging is enabled in the configuration
3. Ensure that storage locations are writable
4. Verify that the system clock is accurate for proper timestamps